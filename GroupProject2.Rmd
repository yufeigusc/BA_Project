---
title: "R Notebook Template for Competition"
author: "Guo Yufei"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    theme: readable
    toc: yes
---

```{r global-options, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      fig.height = 6,
                      fig.width = 6,
                      fig.align = "center")
```


```{r}
train_before_factor = read.csv("Competition_Train.csv")
missing_values <- any(is.na(train_before_factor))

# Print the result
print(missing_values)
```

```{r}
train = read.csv("Competition_Train.csv")
test = read.csv("Competition_Test.csv")
#str(train)
#str(test)
```


We can convert categorical variables to appropriate types.
```{r}
train$potential_issue = as.factor(train$potential_issue)
train[18:23] = lapply(train[18:23], as.factor)
#str(train)
test$potential_issue = as.factor(test$potential_issue)
test[18:22] = lapply(test[18:22], as.factor)
#str(test)

```


```{r}
library(plyr)
train$potential_issue = revalue(train$potential_issue, c("0"="No", "1"="Yes"))
train[18:23] = lapply(train[18:23], function(x) revalue(x, c("0"="No", "1"="Yes")))
#str(train)
test$potential_issue = revalue(test$potential_issue, c("0"="No", "1"="Yes"))
test[18:22] = lapply(test[18:22], function(x) revalue(x, c("0"="No", "1"="Yes")))
#str(test)
```


```{r echo = TRUE, message = FALSE, warning = FALSE}
library(caret)
library(e1071)
```


First, we will define our cross-validation experiment.
```{r}
fitControl = trainControl(method = "cv", number = 10, classProbs = TRUE, summaryFunction = twoClassSummary)
```
The first argument, *method = "cv"*, tells the function to use the cross-validation method. The additional arguments are necessary since we want to use AUC as the performance measure in cross-validation.


```{r}
set.seed(123)
#train(went_on_backorder ~ . - sku, data = train, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")
```


```{r}
set.seed(123)
#train(went_on_backorder ~ national_inv, data = train, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")
```


```{r}
print(colnames(train))
```

- define function

```{r}
logreg <- function(variables, dataset) {
  set.seed(123)
  modelBO = glm(variables, data = dataset, family = "binomial")
  summary(modelBO)
}
```

```{r}
crossv <- function(variables, dataset) {
  set.seed(123)
  results = suppressWarnings(train(variables, data = dataset, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC"))
  print(results$results$ROC)
}
```

```{r}
crossv_no_suppression <- function(variables, dataset) {
  set.seed(123)
  results = train(variables, data = dataset, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")
  print(results$results$ROC)
}
```

```{r}
crossv(went_on_backorder ~ . -lead_time - sku + (lead_time/in_transit_qty), train)
```



```{r}
set.seed(123)
modelBO = glm(went_on_backorder ~ . - sku, data = train, family = "binomial")
summary(modelBO)
```

- delete less significant data: sales_1_month, rev_stop, forecast_9_month, stop_auto_buy, sales_1_month, forecast_3_month

```{r}
temp_data1 = train
temp_data1 = subset(temp_data1, select = -c(sku, sales_1_month, rev_stop, forecast_9_month, stop_auto_buy, sales_1_month, forecast_3_month ))
```

```{r}
set.seed(123)
train(went_on_backorder ~ . , data = temp_data1, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")
```



- add transit efficiency

```{r}
set.seed(123)
train(went_on_backorder ~ . - lead_time + (lead_time/in_transit_qty), data = temp_data1, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")
```

```{r}
set.seed(123)
results = train(went_on_backorder ~ . -lead_time - sku + (lead_time/in_transit_qty), data = train, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")
print(results$results$ROC)
```

```{r}
crossv(went_on_backorder ~ . -lead_time - sku + (lead_time/in_transit_qty) - forecast_9_month - rev_stop, train)
```



- add risk flag
```{r}
risk_flag_sum = rowSums(train_before_factor[, c("deck_risk", "oe_constraint", "ppap_risk", "stop_auto_buy", "rev_stop")])
temp_data2 = train
temp_data2$risk_flag = risk_flag_sum
temp_data2 = subset(temp_data2, select = -c(deck_risk,oe_constraint,ppap_risk,stop_auto_buy,rev_stop))

```


```{r}
crossv(went_on_backorder ~ . -lead_time - sku + (lead_time/in_transit_qty), temp_data2)
```


- remove forecast_9_month

```{r}
crossv(went_on_backorder ~ . -lead_time-sku+(lead_time/in_transit_qty)-forecast_9_month, temp_data2)
```

```{r}
crossv(went_on_backorder ~ . -sku+(lead_time/in_transit_qty)-forecast_9_month, temp_data2)
```

- remove perf, leadtime: 0.8654636

```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time, temp_data2)
```
```{r}
print(colnames(train))
```


- try to remove all sales
```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_9_month, temp_data2)
```
```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-, temp_data2)
```

- remove rev_stop then add risk flag
```{r}
risk_flag_sum = rowSums(train_before_factor[, c("deck_risk", "oe_constraint", "ppap_risk", "stop_auto_buy")])
temp_data3 = train
temp_data3$risk_flag = risk_flag_sum
temp_data3 = subset(temp_data3, select = -c(deck_risk,oe_constraint,ppap_risk,stop_auto_buy,rev_stop))
```

```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_9_month, temp_data3)
```



```{r}
mean(train$lead_time, na.rm = TRUE)
```


- inventory turnover: sales_9_month/(national_inv+in_transit_qty): 0.8693024
6 month: 0.8703366
3 month: 0.8702772
1 month: 0.8719402
1,3 month: 0.8714

```{r}
temp_data4 = temp_data3
temp_data4$inventory_turnover_ratio1 <- ifelse((train$national_inv + train$in_transit_qty) == 0, 0, train$sales_1_month / ((train$national_inv + train$in_transit_qty) / 2))
```

```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time, temp_data4)
```

- remove the other sales
- sales 1: 0.8722761
```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_1_month-min_bank, temp_data4)
```

- add lead time demand : lead_time * (mean(forecast_3_month)/(30*3))
- Don't put it in!!!!!!!!!!!!!!
```{r}
#temp_data5=temp_data4
#mean_forcast_3 = mean(train$forecast_3_month, na.rm = TRUE)
#temp_data5$leadtime_demand = train$lead_time*(mean_forcast_3/9/30)
#crossv_no_suppression(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_1_month-min_bank, temp_data5)

```

- add future sales growth rate: growth rate from period 0-3 to period 3-6
- (forecast_6_month-forecast_3_month-forecast_3_month)/forecast_3_month


```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_1_month-min_bank, temp_data6)
```
0.8773573
```{r}
formula = as.formula(
  went_on_backorder ~ . - sku +lead_time/in_transit_qty - lead_time
  - perf_12_month_avg - perf_6_month_avg - sales_1_month - min_bank
  +(forecast_6_month-forecast_3_month-forecast_3_month)/forecast_3_month
)

crossv(formula, temp_data4)
```


```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_1_month-min_bank-forecast_6_month, temp_data6)
```

- remove deck_risk from risk flag
```{r}
temp_data6 = temp_data4
temp_data6$risk_flag = temp_data6$risk_flag - train_before_factor$deck_risk


# Print the result
print(missing_values)
```

```{r}
crossv(went_on_backorder ~ . - sku+lead_time/in_transit_qty-perf_12_month_avg-perf_6_month_avg-lead_time-sales_1_month-min_bank-forecast_6_month-forecast_9_month, temp_data6)
```


- from 0.8734018 to:
- -stop_auto_by 0.8779033
- -deck_risk - stop_auto_buy 0.8757226
- -deck_risk 0.8796093

```{r}
formula = as.formula(
  went_on_backorder ~ . - sku +lead_time/in_transit_qty - lead_time
  - perf_12_month_avg - perf_6_month_avg - sales_1_month - min_bank
  +(forecast_6_month-forecast_3_month-forecast_3_month)/forecast_3_month
)
crossv(formula, temp_data6)
```

- multiplication on local_bo_qty and pieces_past_due help a little
  overdue_factor = local_bo_qty * pieces_past_due
```{r}
temp_data7 = temp_data6
temp_data7$overdue_factor = temp_data7$local_bo_qty*temp_data7$pieces_past_due
```

```{r}
formula = as.formula(
  went_on_backorder ~ . - sku +lead_time/in_transit_qty - lead_time
  - perf_12_month_avg - perf_6_month_avg - sales_1_month - min_bank
  +(forecast_6_month-forecast_3_month-forecast_3_month)/forecast_3_month
  + local_bo_qty*pieces_past_due
)
crossv(formula, temp_data6)
```

```{r}
formula = as.formula(
  went_on_backorder ~ . - sku +lead_time/in_transit_qty - lead_time
  - perf_12_month_avg - perf_6_month_avg - sales_1_month - min_bank
  +(forecast_6_month-forecast_3_month-forecast_3_month)/forecast_3_month
  + local_bo_qty*pieces_past_due
  - forecast_9_month - forecast_3_month
  
)
crossv(formula, temp_data6)
```


```{r}
crossv(formula, temp_data6)
```




- ratio on peices_past_due and local_bo_qty does not help much
```{r}
#temp_data9 = temp_data8
#temp_data9$overdue_norm_ration = (train$pieces_past_due/max(train$pieces_past_due)) / #(train$local_bo_qty/max(train$local_bo_qty) + 1)
```

- work on sales

```{r}
temp_data9 = temp_data8
temp_data9$transit_efficiency = train$lead_time/(train$in_transit_qty+1)
temp_data9 = subset(temp_data9, select = -c(sku,perf_12_month_avg,perf_6_month_avg,sales_1_month,min_bank,forecast_6_month,forecast_9_month))
print(colnames(temp_data9))
```
```{r}
crossv(went_on_backorder ~ .  - transit_efficiency + lead_time/in_transit_qty - lead_time, temp_data9)
```


```{r}
library(corrplot) # For correlation plot visualization
temp_cor = subset(temp_data8, select = -c(went_on_backorder,perf_12_month_avg,perf_6_month_avg,lead_time,sales_1_month,min_bank,forecast_6_month,forecast_9_month))
temp_cor$potential_issue = train_before_factor$potential_issue
correlation_matrix = cor(temp_cor)
corrplot(correlation_matrix, method = "circle")
```


- previous dataset
```{r}
temp_data3 = train_before_factor
temp_data3$transit_rate <- ifelse(temp_data3$lead_time == 0, 0, temp_data3$in_transit_qty / temp_data3$lead_time)
temp_data3$risk_flag = temp_data3$deck_risk+temp_data3$oe_constraint+temp_data3$ppap_risk+temp_data3$stop_auto_buy+temp_data3$rev_stop+temp_data3$potential_issue


missing_values <- any(is.na(temp_data3$risk_flag))

# Print the result
print(missing_values)


temp_data3 = subset(temp_data3, select = -c(deck_risk,oe_constraint,ppap_risk,stop_auto_buy,rev_stop,potential_issue))

temp_data3$went_on_backorder = as.factor(temp_data3$went_on_backorder)
temp_data3$went_on_backorder = revalue(temp_data3$went_on_backorder, c("0"="No", "1"="Yes"))

print(colnames(temp_data3))

set.seed(123)
train(went_on_backorder ~ . -sku , data = temp_data3, method = "glm", family = "binomial", trControl = fitControl, metric = "ROC")

```



Between these two logistic regression models, the first one with all the independent variables performs better in cross-validation. Now, we will retrain the selected model using the whole training set.
```{r}
modelBO = glm(went_on_backorder ~ . - sku, data = train, family = "binomial")
summary(modelBO)
```


# Preparing the Predictions for Testing


Using the selected model, we make the predictions on the test set and save *sku* and the predicted probabilities of backorder in a data frame.
```{r}
PredBO = predict(modelBO, newdata = test, type = "response")
PredTest = data.frame(test$sku, PredBO)
str(PredTest)
```


```{r}
summary(PredTest)
```


Finally, we tally the variable names and save the predictions in a file. The file can be submitted. The argument, *row.names = FALSE*, prevent R from saving additional column with indecies for each row.
```{r}
colnames(PredTest) = c("sku", "went_on_backorder")
str(PredTest)
write.csv(PredTest, "Sample_Submission.csv", row.names = FALSE)
```


